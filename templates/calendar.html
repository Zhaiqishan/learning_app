{% extends "base.html" %}

{% block content %}
<div class="glass-effect p-8 rounded-lg text-white">
    <h1 class="text-4xl font-bold mb-6">üìÖ Study Calendar & Planner</h1>

    <!-- Year Selector -->
    <div class="mb-6">
        <select id="yearSelect" class="select select-bordered w-full max-w-xs">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
            <option value="2027">2027</option>
            <option value="2028">2028</option>
            <option value="2029">2029</option>
            <option value="2030">2030</option>
        </select>
    </div>

    <!-- Month Selector -->
    <div class="mb-6 flex flex-wrap gap-2">
        <button class="btn btn-sm btn-primary" onclick="showMonth(0)">Jan</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(1)">Feb</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(2)">Mar</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(3)">Apr</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(4)">May</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(5)">Jun</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(6)">Jul</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(7)">Aug</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(8)">Sep</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(9)">Oct</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(10)">Nov</button>
        <button class="btn btn-sm btn-ghost" onclick="showMonth(11)">Dec</button>
    </div>

    <!-- Calendar Grid -->
    <div id="calendarGrid" class="grid grid-cols-7 gap-2 mb-8">
        <!-- Generated by JavaScript -->
    </div>

    <!-- Plan Editor Modal -->
    <dialog id="planModal" class="modal">
        <div class="modal-box">
            <h3 class="font-bold text-lg" id="modalTitle">Study Plan</h3>
            <div class="form-control mt-4">
                <textarea id="planContent" class="textarea textarea-bordered" rows="5"
                          placeholder="Enter your study plan..."></textarea>
            </div>
            <div class="modal-action">
                <button class="btn btn-primary" onclick="savePlan()">Save</button>
                <button class="btn btn-success" onclick="completePlan()">Mark Complete üéâ</button>
                <button class="btn" onclick="planModal.close()">Close</button>
            </div>
        </div>
    </dialog>
</div>

<script>
let currentYear = 2025;
let currentMonth = 0;
let selectedDate = null;

function showMonth(month) {
    currentMonth = month;
    const year = parseInt(document.getElementById('yearSelect').value);
    currentYear = year;

    // Update button styles
    document.querySelectorAll('[onclick^="showMonth"]').forEach((btn, idx) => {
        btn.className = idx === month ? 'btn btn-sm btn-primary' : 'btn btn-sm btn-ghost';
    });

    generateCalendar(year, month);
}

function generateCalendar(year, month) {
    const grid = document.getElementById('calendarGrid');
    grid.innerHTML = '';

    // Day headers
    ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
        const header = document.createElement('div');
        header.className = 'text-center font-bold p-2 bg-base-300 rounded';
        header.textContent = day;
        grid.appendChild(header);
    });

    // Get first day and total days
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();

    // Empty cells before first day
    for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div');
        grid.appendChild(empty);
    }

    // Date cells
    for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        cell.className = 'bg-base-200 p-4 rounded cursor-pointer hover:bg-base-300 transition min-h-[80px] flex flex-col justify-between';
        cell.innerHTML = `<div class="font-bold">${day}</div><div class="text-xs mt-2" id="plan-${year}-${month}-${day}"></div>`;
        cell.onclick = () => openPlanModal(year, month, day);
        grid.appendChild(cell);

        // Load existing plan
        loadPlan(year, month, day);
    }
}

function openPlanModal(year, month, day) {
    selectedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    document.getElementById('modalTitle').textContent = `Study Plan for ${selectedDate}`;

    fetch(`/calendar/plan?date=${selectedDate}`)
        .then(r => r.json())
        .then(data => {
            document.getElementById('planContent').value = data.content || '';
        });

    planModal.showModal();
}

function savePlan() {
    const content = document.getElementById('planContent').value;
    const formData = new FormData();
    formData.append('date', selectedDate);
    formData.append('content', content);

    fetch('/calendar/plan', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Plan saved successfully! ‚úÖ');
            planModal.close();
            const [year, month, day] = selectedDate.split('-');
            loadPlan(parseInt(year), parseInt(month) - 1, parseInt(day));
        }
    });
}

function completePlan() {
    const formData = new FormData();
    formData.append('date', selectedDate);

    fetch('/calendar/complete', {
        method: 'POST',
        body: formData
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            alert('Congratulations! üéâ Plan completed!');
            planModal.close();
        }
    });
}

function loadPlan(year, month, day) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    fetch(`/calendar/plan?date=${dateStr}`)
        .then(r => r.json())
        .then(data => {
            const planDiv = document.getElementById(`plan-${year}-${month}-${day}`);
            if (planDiv) {
                if (data.is_completed) {
                    planDiv.innerHTML = '‚úÖ Completed';
                    planDiv.parentElement.classList.add('bg-success', 'text-white');
                } else if (data.content) {
                    planDiv.innerHTML = 'üìù Planned';
                    planDiv.parentElement.classList.add('bg-warning', 'text-black');
                }
            }
        });
}

// Initialize
document.getElementById('yearSelect').addEventListener('change', function() {
    showMonth(currentMonth);
});

// Show current month on load
showMonth(new Date().getMonth());
</script>
{% endblock %}
